<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dodge the Falling Blocks â€” Desktop (Leaderboard via Supabase)</title>
<style>
  :root{--bg:#1e1e1e;--panel:#222;--accent:gold;--muted:#bbb}
  html,body{height:100%;margin:0;background:#282828;font-family:Arial,Helvetica,sans-serif;color:#fff}
  /* Canvas: not receiving pointer events until player continues */
  canvas{display:block;background:var(--bg);margin:0 auto;max-height:100vh;pointer-events:none;z-index:0}
  /* overlays */
  .overlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:60;color:#fff;background:rgba(0,0,0,0.66);padding:18px;border-radius:12px;text-align:center;min-width:320px}
  .overlay h1{margin:0 0 8px 0;font-size:20px}
  .overlay input{font-size:16px;padding:8px;border-radius:8px;border:1px solid #444;background:#111;color:#fff}
  .overlay button{margin-top:10px;padding:8px 12px;border-radius:8px;border:none;background:#333;color:#fff;cursor:pointer;font-size:15px}
  .muted{color:var(--muted);font-size:13px}
  #coin-counter-game{position:fixed;top:12px;right:12px;z-index:70;color:var(--accent);font-weight:bold;font-size:16px;display:none}
  #color-grid{display:grid;grid-template-columns:repeat(6,44px);gap:8px;justify-content:center;margin-top:12px}
  .color-cell{width:44px;height:44px;border-radius:8px;border:2px solid #fff;cursor:pointer;position:relative}
  .price-overlay{position:absolute;bottom:0;left:0;right:0;text-align:center;font-size:11px;color:var(--accent);background:rgba(0,0,0,0.45);padding:2px 0;border-bottom-left-radius:6px;border-bottom-right-radius:6px}
  .check-overlay{position:absolute;top:4px;right:6px;font-weight:bold}
  .skin-card{width:72px;height:56px;border-radius:8px;overflow:hidden;border:2px solid #fff;display:flex;align-items:center;justify-content:center;background:#111;position:relative;cursor:pointer;margin:6px}
  .skin-card img{max-width:68px;max-height:52px;display:block}
  .panel{background:var(--panel);padding:12px;border-radius:8px}
  .small{padding:8px 12px;font-size:14px;border-radius:8px;background:#333;color:#fff;border:none;cursor:pointer;margin:6px}
  .hidden{display:none !important}
  .entry{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
  .meta{color:var(--muted);font-size:12px}
  @media (max-width:800px){ .overlay{width:92vw} #color-grid{grid-template-columns:repeat(4,44px)} canvas{width:100%;height:calc(100vh - 0px)} }
</style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <!-- Username -->
  <div id="username-screen" class="overlay" role="dialog" aria-modal="true">
    <h1>Enter Username</h1>
    <input id="username-input" maxlength="16" placeholder="Your name" />
    <div class="muted">Type your name and press Continue</div>
    <button id="start-username">Continue</button>
  </div>

  <!-- Title -->
  <div id="title-screen" class="overlay hidden" role="dialog" aria-hidden="true">
    <div style="font-weight:bold;font-size:20px">Dodge the Falling Blocks</div>
    <small class="muted">Press Start or press <strong>#</strong> to begin</small>
    <div id="coin-counter-title" style="margin-top:10px;color:var(--accent);font-weight:bold">Coins: 0</div>

    <div style="display:flex;gap:12px;justify-content:center;margin-top:12px;flex-wrap:wrap">
      <div>
        <div class="muted" style="margin-bottom:6px;text-align:left">Colors (50 coins)</div>
        <div id="color-grid"></div>
      </div>
      <div style="min-width:180px">
        <div class="muted" style="margin-bottom:6px;text-align:left">Skins (50,000 coins)</div>
        <div id="skins" style="display:flex;flex-wrap:wrap"></div>
        <div style="margin-top:8px">
          <input id="upload-skin" type="file" accept="image/*" />
          <div class="muted" style="margin-top:6px">Upload a custom skin (kept local). Buy in shop for 50,000 coins.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pause / Shop / Leader / Game Over -->
  <div id="pauseMenu" class="overlay hidden panel" role="dialog" aria-hidden="true" style="min-width:280px">
    <div style="font-weight:bold">Paused</div>
    <button id="pause-resume" class="small">Resume (P)</button>
    <button id="pause-restart" class="small">Restart (R)</button>
    <button id="pause-shop" class="small">Shop (P)</button>
    <button id="pause-leader" class="small">Leaderboard (L)</button>
    <button id="pause-close" class="small">Close</button>
  </div>

  <div id="shopModal" class="overlay hidden panel" role="dialog" aria-hidden="true" style="max-height:80vh;overflow:auto">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:bold">Shop</div>
      <div>
        <button id="shop-clear" class="small">Clear</button>
        <button id="shop-close" class="small">Close</button>
      </div>
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
      <div>
        <div class="muted" style="margin-bottom:6px;text-align:left">Colors (50 coins)</div>
        <div id="shop-color-grid"></div>
      </div>
      <div style="min-width:200px">
        <div class="muted" style="margin-bottom:6px;text-align:left">Custom Skin (50,000 coins)</div>
        <div id="shop-skins" style="display:flex;flex-wrap:wrap"></div>
        <div style="margin-top:8px">
          <input id="shop-upload-skin" type="file" accept="image/*" />
          <div class="muted" style="margin-top:6px">Upload an image for the custom skin slot (local + optional Supabase not used).</div>
        </div>
      </div>
    </div>
  </div>

  <div id="leaderModal" class="overlay hidden panel" role="dialog" aria-hidden="true" style="max-height:80vh;overflow:auto">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:bold">Leaderboard (Public)</div>
      <div>
        <button id="clear-leader" class="small">Clear local</button>
        <button id="close-leader" class="small">Close</button>
      </div>
    </div>
    <div id="leader-list" style="margin-top:10px"></div>
  </div>

  <div id="game-over" class="overlay hidden" role="dialog">
    <div style="font-size:22px;font-weight:bold">Game Over!</div>
    <div style="color:var(--muted);margin-top:6px">Score: <span id="final-score">0</span></div>
    <div style="margin-top:8px">
      <button id="go-restart" class="small">Restart</button>
      <button id="go-title" class="small">Main Menu</button>
    </div>
  </div>

  <div id="coin-counter-game" aria-hidden="true">Coins: 0</div>

  <!-- Supabase client (only for leaderboard) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
/* ============================
   Supabase (leaderboard only)
   ============================ */
const SUPABASE_URL = 'https://umkurrwggozuwzonfwtd.supabase.co';
const SUPABASE_KEY = 'sb_publishable_8QezEDFWMXH4s0HdYbMAjw_fglqt5o9';
const supabase = (typeof supabase !== 'undefined' && supabase.createClient) ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

/* Submit a score to the Supabase public leaderboard (no auth) */
async function submitScoreToSupabase(name, sc){
  if (!supabase) return;
  try {
    const { error } = await supabase.from('leaderboard').insert([{ username: name, score: sc }]);
    if (error) console.warn('Supabase insert leaderboard error:', error);
  } catch (e){
    console.error('submitScoreToSupabase error', e);
  }
}

/* Fetch top leaderboard rows */
async function fetchLeaderboard(limit = 50){
  if (!supabase) return [];
  try {
    const { data, error } = await supabase.from('leaderboard').select('username,score,created_at').order('score', { ascending: false }).limit(limit);
    if (error) { console.warn('Supabase fetch leaderboard error:', error); return []; }
    return data || [];
  } catch (e){
    console.error('fetchLeaderboard error', e);
    return [];
  }
}

/* ============================
   Canvas + responsive
   ============================ */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
function fitCanvas(){ canvas.width = Math.min(window.innerWidth, 1200); canvas.height = Math.min(window.innerHeight, 900); }
fitCanvas();
window.addEventListener('resize', () => { fitCanvas(); player.x = Math.min(player.x, canvas.width - player.width); player.y = canvas.height - 40; });

/* ============================
   DOM refs
   ============================ */
const usernameScreen = document.getElementById('username-screen');
const usernameInput = document.getElementById('username-input');
const startUsernameBtn = document.getElementById('start-username');

const titleScreen = document.getElementById('title-screen');
const coinCounterTitle = document.getElementById('coin-counter-title');
const colorGrid = document.getElementById('color-grid');
const skinsContainer = document.getElementById('skins');
const uploadSkinInput = document.getElementById('upload-skin');

const coinCounterGame = document.getElementById('coin-counter-game');
const gameOverOverlay = document.getElementById('game-over');
const finalScoreEl = document.getElementById('final-score');
const goRestart = document.getElementById('go-restart');
const goTitle = document.getElementById('go-title');

const pauseMenu = document.getElementById('pauseMenu');
const pauseResume = document.getElementById('pause-resume');
const pauseRestart = document.getElementById('pause-restart');
const pauseShop = document.getElementById('pause-shop');
const pauseLeader = document.getElementById('pause-leader');
const pauseClose = document.getElementById('pause-close');

const shopModal = document.getElementById('shopModal');
const shopClose = document.getElementById('shop-close');
const shopColorGrid = document.getElementById('shop-color-grid');
const shopSkins = document.getElementById('shop-skins');
const shopUploadSkin = document.getElementById('shop-upload-skin');
const shopClear = document.getElementById('shop-clear');

const leaderModal = document.getElementById('leaderModal');
const leaderList = document.getElementById('leader-list');
const closeLeader = document.getElementById('close-leader');
const clearLeader = document.getElementById('clear-leader');

/* ============================
   Game state & local persistence
   (Option B: local coins/colors/skins; Supabase only leaderboard)
   ============================ */
let username = '';
let coins = parseInt(localStorage.getItem('coins') || '0', 10);
let unlockedColors = JSON.parse(localStorage.getItem('unlockedColors') || '["#00FF00"]');
let selectedColor = localStorage.getItem('selectedColor') || '#00FF00';
let selectedSkinLocal = localStorage.getItem('customSkinData') || null;

const shopColors = [
  "#00FF00","#FF0000","#0000FF","#FFFF00","#FF00FF","#00FFFF","#FFA500","#FFFFFF",
  "#D61326","#13C9D6","#44BEC9","#390069","#7773BD","#4A4C78","#261517","#407FC2","#88FF00","#000000",
  "#0800FF","#2E2D57","#422D57","#F700FF","#FF0080"
];
const SKIN_COST = 50000;

let score = 0;
let highScore = parseInt(localStorage.getItem('highScore') || '0', 10);

let gameStarted = false;
let gamePaused = false;
let gameOver = false;

/* Player (half size) */
const player = {
  width: 25, height: 25,
  x: canvas.width/2 - 12.5,
  y: canvas.height - 40,
  speed: 5, dx: 0,
  color: '#00FF00',
  skin: null
};

/* Obstacles & powerups */
let obstacles = [];
let powerups = [];
let obstacleSpawnProb = 0.03; // spawn chance per frame
const POWERUP_FREQ = 125; // spawn 1/POWERUP_FREQ chance per frame

/* Powerup timers/durations */
let invincible = false, invincibleTimer = 0, INVINCIBLE_DURATION = 5000;
let slowed = false, slowTimer = 0, SLOW_DURATION = 5000;
let speedBoosted = false, speedBoostTimer = 0, SPEEDBOOST_DURATION = 5000;
const SPEEDBOOST_MULT = 1.5;

/* RAF */
let rafId = null;

/* ============================
   Helpers for local persistence
   ============================ */
function saveLocalState(){
  localStorage.setItem('coins', String(coins));
  localStorage.setItem('unlockedColors', JSON.stringify(unlockedColors));
  localStorage.setItem('selectedColor', selectedColor);
  if (selectedSkinLocal) localStorage.setItem('customSkinData', selectedSkinLocal);
  localStorage.setItem('highScore', String(highScore));
  updateCoinDisplays();
}
function updateCoinDisplays(){
  document.getElementById('coin-counter-game').textContent = 'Coins: ' + coins;
  coinCounterTitle.textContent = 'Coins: ' + coins;
}

/* ============================
   Drawing helpers
   ============================ */
function drawPlayer(){
  if (player.skin || selectedSkinLocal){
    const img = new Image();
    img.src = player.skin || selectedSkinLocal;
    ctx.drawImage(img, player.x, player.y, player.width, player.height);
    return;
  }
  let fill = selectedColor || player.color;
  if (slowed) fill = 'navy';
  if (invincible) fill = 'cyan';
  ctx.fillStyle = fill;
  ctx.fillRect(player.x, player.y, player.width, player.height);
}

/* Progress bars stacked above the player (no overlap) */
function drawPowerupBars(){
  const barW = 40, barH = 6, gap = 4;
  let offsetY = -10;
  const bars = [];
  if (invincible){
    const elapsed = Date.now() - invincibleTimer;
    const remaining = Math.max(0, 1 - elapsed / INVINCIBLE_DURATION);
    bars.push({ color: 'cyan', remaining });
  }
  if (slowed){
    const elapsed = Date.now() - slowTimer;
    const remaining = Math.max(0, 1 - elapsed / SLOW_DURATION);
    bars.push({ color: 'navy', remaining });
  }
  if (speedBoosted){
    const elapsed = Date.now() - speedBoostTimer;
    const remaining = Math.max(0, 1 - elapsed / SPEEDBOOST_DURATION);
    bars.push({ color: 'gold', remaining });
  }
  for (let i = 0; i < bars.length; i++){
    const b = bars[i];
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(player.x + player.width/2 - barW/2 - 1, player.y + offsetY - 1, barW + 2, barH + 2);
    ctx.fillStyle = b.color;
    ctx.fillRect(player.x + player.width/2 - barW/2, player.y + offsetY, barW * b.remaining, barH);
    offsetY -= (barH + gap);
  }
}

function drawObstacles(){
  for (let i = 0; i < obstacles.length; i++){
    const o = obstacles[i];
    ctx.fillStyle = '#F00';
    ctx.fillRect(o.x, o.y, o.w, o.h);
  }
}

function drawPowerups(){
  for (let i = 0; i < powerups.length; i++){
    const p = powerups[i];
    if (p.type === 'invincible') ctx.fillStyle = 'cyan';
    else if (p.type === 'slow') ctx.fillStyle = 'navy';
    else if (p.type === 'speed') ctx.fillStyle = 'gold';
    ctx.fillRect(p.x, p.y, p.size, p.size);
  }
}

function drawHUD(){
  ctx.fillStyle = '#FFF';
  ctx.font = '16px Arial';
  ctx.fillText('Score: ' + score, 10, 24);
  ctx.fillText('High: ' + highScore, 10, 44);
  ctx.fillStyle = 'gold';
  ctx.fillText('Coins: ' + coins, 10, 68);
}

/* ============================
   Mechanics & spawning
   ============================ */
function generateObstacle(){
  const w = Math.random() * (canvas.width / 4) + 25;
  const x = Math.random() * (canvas.width - w);
  const speed = (Math.random() * 3.5 + 3) * 0.5; // 50% slower
  obstacles.push({ x, y: -25, w, h: 25, speed });
}

function maybeSpawnPowerup(){
  if (Math.random() < 1 / POWERUP_FREQ){
    const types = [ 'invincible', 'slow', 'speed' ];
    const type = types[Math.floor(Math.random() * types.length)];
    const size = 15;
    const x = Math.random() * (canvas.width - size);
    powerups.push({ x, y: -size, size, type, speed: 1.5 });
  }
}

function updateObstacles(){
  for (let i = obstacles.length - 1; i >= 0; i--){
    const o = obstacles[i];
    let eff = o.speed;
    if (slowed) eff *= 0.5;
    o.y += eff;
    if (o.y > canvas.height){
      obstacles.splice(i, 1);
      score += 1;
      coins += 1;
      saveLocalState();
      if (score > highScore){ highScore = score; saveLocalState(); }
    }
  }
}

function updatePowerups(){
  for (let i = powerups.length - 1; i >= 0; i--){
    const p = powerups[i];
    p.y += p.speed;
    if (p.y > canvas.height + p.size){
      powerups.splice(i, 1);
      continue;
    }
    if (p.x < player.x + player.width &&
        p.x + p.size > player.x &&
        p.y < player.y + player.height &&
        p.y + p.size > player.y){
      if (p.type === 'invincible'){
        invincible = true; invincibleTimer = Date.now();
      } else if (p.type === 'slow'){
        slowed = true; slowTimer = Date.now();
      } else if (p.type === 'speed'){
        if (!speedBoosted){
          player.speed = player.speed * SPEEDBOOST_MULT;
        }
        speedBoosted = true; speedBoostTimer = Date.now();
      }
      powerups.splice(i, 1);
    }
  }
}

function checkCollisions(){
  for (let i = 0; i < obstacles.length; i++){
    const o = obstacles[i];
    if (!invincible &&
        o.x < player.x + player.width &&
        o.x + o.w > player.x &&
        o.y < player.y + player.height &&
        o.y + o.h > player.y){
      onGameOver();
      return;
    }
  }
}

function updateTimers(){
  if (invincible && Date.now() - invincibleTimer > INVINCIBLE_DURATION) invincible = false;
  if (slowed && Date.now() - slowTimer > SLOW_DURATION) slowed = false;
  if (speedBoosted && Date.now() - speedBoostTimer > SPEEDBOOST_DURATION){
    speedBoosted = false;
    player.speed = 5;
  }
}

/* ============================
   Leaderboard (Supabase + local fallback)
   ============================ */
async function pushToLeaderboards(finalScore){
  // local save
  const entry = { username: username || 'Player', score: finalScore, date: new Date().toLocaleString() };
  const listLocal = JSON.parse(localStorage.getItem('leaderboard') || '[]');
  listLocal.push(entry);
  localStorage.setItem('leaderboard', JSON.stringify(listLocal.slice(-200)));

  // Supabase public insert (best-effort)
  if (supabase) {
    try {
      const { error } = await supabase.from('leaderboard').insert([{ username: username || 'Player', score: finalScore }]);
      if (error) console.warn('Supabase insert error', error);
    } catch (e){
      console.error('Supabase insert exception', e);
    }
  }
}

async function renderLeaderboard(){
  leaderList.innerHTML = '<div style="color:var(--muted);padding:8px">Loading...</div>';
  let rows = [];
  if (supabase){
    try { rows = await fetchLeaderboard(50); } catch (e){ rows = []; }
  }
  // if supabase failed, use local
  if (!rows || rows.length === 0){
    const localList = JSON.parse(localStorage.getItem('leaderboard') || '[]').slice(-50).reverse();
    leaderList.innerHTML = '';
    if (!localList.length){ leaderList.innerHTML = '<div style="color:var(--muted);padding:8px">No scores yet</div>'; return; }
    localList.forEach((e,i)=>{
      const div = document.createElement('div'); div.className = 'entry';
      div.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><div style="font-weight:bold">${i+1}.</div><div><div style="font-weight:bold">${escapeHtml(e.username)}</div><div class="meta">${e.date}</div></div></div><div style="font-weight:bold">${e.score}</div>`;
      leaderList.appendChild(div);
    });
    return;
  }
  // render supabase rows
  leaderList.innerHTML = '';
  rows.forEach((row, i) => {
    const div = document.createElement('div'); div.className = 'entry';
    div.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><div style="font-weight:bold">${i<3?['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'][i] : (i+1)+'.'}</div><div><div style="font-weight:bold">${escapeHtml(row.username)}</div><div class="meta">${new Date(row.created_at).toLocaleString()}</div></div></div><div style="font-weight:bold">${row.score}</div>`;
    leaderList.appendChild(div);
  });
}

/* ============================
   Shop rendering & purchases (local)
   ============================ */
function renderColorGrid(target){
  target.innerHTML = '';
  shopColors.forEach(c => {
    const cell = document.createElement('div');
    cell.className = 'color-cell';
    cell.style.backgroundColor = c;
    if (unlockedColors.includes(c)){
      const chk = document.createElement('div'); chk.className = 'check-overlay'; chk.textContent = 'âœ“'; cell.appendChild(chk);
    } else {
      const overlay = document.createElement('div'); overlay.className = 'price-overlay'; overlay.textContent = 'ðŸª™ 50'; cell.appendChild(overlay);
    }
    cell.addEventListener('click', () => {
      if (unlockedColors.includes(c)){
        selectedColor = c; player.skin = null; selectedSkinLocal = null; saveLocalState(); pushUI();
      } else {
        if (coins >= 50){
          coins -= 50; unlockedColors.push(c); saveLocalState();
          renderColorGrid(colorGrid); renderColorGrid(shopColorGrid);
          pushUI();
        } else {
          alert('Not enough coins (50).');
        }
      }
    });
    target.appendChild(cell);
  });
}

function renderSkins(target){
  target.innerHTML = '';
  const skins = [
    { id:'default', name:'Default', cost:0 },
    { id:'special', name:'Custom Skin', cost:SKIN_COST }
  ];
  skins.forEach(s => {
    const card = document.createElement('div'); card.className = 'skin-card';
    const img = document.createElement('img');
    if (s.id === 'default'){
      const c = document.createElement('canvas'); c.width = 64; c.height = 48; const p = c.getContext('2d'); p.fillStyle = '#00FF00'; p.fillRect(0,0,64,48); img.src = c.toDataURL();
    } else {
      const data = localStorage.getItem('customSkinData') || null;
      if (data) img.src = data; else { const c = document.createElement('canvas'); c.width = 64; c.height = 48; const p = c.getContext('2d'); p.fillStyle = '#FFD700'; p.fillRect(0,0,64,48); p.fillStyle = '#000'; p.font = '10px Arial'; p.fillText('Custom',6,26); img.src = c.toDataURL(); }
    }
    card.appendChild(img);
    const price = document.createElement('div'); price.style.position = 'absolute'; price.style.bottom = '6px'; price.style.left = 0; price.style.right = 0; price.style.textAlign = 'center'; price.style.color = 'var(--accent)'; price.style.fontSize = '12px';
    price.textContent = s.cost ? 'ðŸª™ ' + s.cost : 'Owned';
    card.appendChild(price);
    card.addEventListener('click', () => {
      if (s.id === 'default'){
        player.skin = null; selectedSkinLocal = null; selectedColor = '#00FF00'; saveLocalState(); pushUI();
      } else {
        const data = localStorage.getItem('customSkinData');
        if (!data){ alert('Upload a custom skin first using the upload control.'); return; }
        // If skin cost hasn't been "purchased", we'll treat purchase state as local unlocked flag
        const unlocked = !!localStorage.getItem('specialUnlocked');
        if (unlocked){
          player.skin = data; selectedSkinLocal = data; saveLocalState(); pushUI();
        } else {
          if (coins >= SKIN_COST){
            if (confirm(`Buy custom skin slot for ${SKIN_COST} coins?`)){
              coins -= SKIN_COST; localStorage.setItem('specialUnlocked','1'); saveLocalState(); renderSkins(skinsContainer); renderSkins(shopSkins); pushUI();
            }
          } else alert('Not enough coins.');
        }
      }
    });
    target.appendChild(card);
  });
}

/* upload handlers (local only) */
uploadSkinInput.addEventListener('change', (e) => {
  const f = e.target.files && e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = (ev) => {
    localStorage.setItem('customSkinData', ev.target.result);
    selectedSkinLocal = ev.target.result;
    renderSkins(skinsContainer);
    renderSkins(shopSkins);
    alert('Custom skin saved locally. Buy/select it in Skins (50,000 coins).');
  };
  r.readAsDataURL(f);
});
shopUploadSkin.addEventListener('change', (e) => {
  const f = e.target.files && e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = (ev) => {
    localStorage.setItem('customSkinData', ev.target.result);
    selectedSkinLocal = ev.target.result;
    renderSkins(skinsContainer);
    renderSkins(shopSkins);
    alert('Custom skin saved locally.');
  };
  r.readAsDataURL(f);
});

/* ============================
   Utilities
   ============================ */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function pushUI(){ updateCoinDisplays(); saveLocalState(); }

/* ============================
   Input & UI flow (fixed Continue)
   ============================ */
async function handleContinue(e){
  if (e && e.preventDefault) e.preventDefault();
  username = usernameInput.value.trim() || 'Player';
  try{ usernameInput.blur(); }catch(_){}
  // Hide username overlay after small delay, enable canvas pointer events so gameplay can capture clicks if needed
  setTimeout(()=>{
    usernameScreen.classList.add('hidden');
    titleScreen.classList.remove('hidden');
    // enable canvas interactions now that overlays are hidden
    canvas.style.pointerEvents = 'auto';
    // refresh UI
    renderColorGrid(colorGrid);
    renderSkins(skinsContainer);
    renderColorGrid(shopColorGrid);
    renderSkins(shopSkins);
    updateCoinDisplays();
  }, 120);
}
startUsernameBtn.addEventListener('pointerdown', handleContinue, {passive:false});
startUsernameBtn.addEventListener('click', handleContinue);
usernameInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') handleContinue(e); });

/* Start game from title (click or press '#') */
function startGame(){
  if (gameStarted) return;
  gameStarted = true; gamePaused = false; gameOver = false; score = 0;
  obstacles.length = 0; powerups.length = 0;
  titleScreen.classList.add('hidden'); gameOverOverlay.classList.add('hidden');
  coinCounterGame.style.display = 'block';
  player.dx = 0;
  if (!rafId) rafId = requestAnimationFrame(gameLoop);
}
titleScreen.addEventListener('pointerdown', (e) => { e.preventDefault(); startGame(); }, {passive:false});

/* Keyboard controls */
document.addEventListener('keydown', (e) => {
  if (!gameStarted && !titleScreen.classList.contains('hidden') && e.key === '#') startGame();
  if (e.key === 'ArrowLeft') player.dx = -player.speed;
  if (e.key === 'ArrowRight') player.dx = player.speed;
  if (e.key.toLowerCase() === 'r') restartGame();
  if (e.key.toLowerCase() === 'l') { openLeaderModal(); }
  if (e.key.toLowerCase() === 'p'){
    if (!gameStarted) return;
    if (!gamePaused){
      gamePaused = true;
      pauseMenu.classList.remove('hidden');
      if (rafId){ cancelAnimationFrame(rafId); rafId = null; }
    } else {
      resumeGame();
    }
  }
});
document.addEventListener('keyup', (e) => {
  if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') player.dx = 0;
});

/* Pause / resume */
function resumeGame(){
  gamePaused = false;
  pauseMenu.classList.add('hidden');
  if (!rafId) rafId = requestAnimationFrame(gameLoop);
}
pauseResume.addEventListener('click', resumeGame);
pauseRestart.addEventListener('click', ()=> { restartGame(); pauseMenu.classList.add('hidden'); });
pauseShop.addEventListener('click', ()=> openShopModal());
pauseLeader.addEventListener('click', ()=> openLeaderModal());
pauseClose.addEventListener('click', ()=> resumeGame());

/* Game over */
async function onGameOver(){
  gameOver = true;
  gameStarted = false;
  gamePaused = false;
  finalScoreEl.textContent = String(score);
  await pushToLeaderboards(score); // local + supabase
  gameOverOverlay.classList.remove('hidden');
  coinCounterGame.style.display = 'none';
  if (rafId){ cancelAnimationFrame(rafId); rafId = null; }
}
goRestart.addEventListener('click', ()=> restartGame());
goTitle.addEventListener('click', ()=> { gameOverOverlay.classList.add('hidden'); titleScreen.classList.remove('hidden'); });

/* Shop / leader modal */
function openShopModal(){ shopModal.classList.remove('hidden'); renderColorGrid(shopColorGrid); renderSkins(shopSkins); }
function closeShopModal(){ shopModal.classList.add('hidden'); saveLocalState(); }
document.getElementById('shop-close').addEventListener('click', closeShopModal);
shopClear.addEventListener('click', ()=> { if (confirm('Clear custom skin & unlock flag?')){ localStorage.removeItem('customSkinData'); localStorage.removeItem('specialUnlocked'); selectedSkinLocal = null; renderSkins(skinsContainer); renderSkins(shopSkins); } });

async function openLeaderModal(){ await renderLeaderboard(); leaderModal.classList.remove('hidden'); }
document.getElementById('close-leader').addEventListener('click', ()=> leaderModal.classList.add('hidden'));
document.getElementById('clear-leader').addEventListener('click', ()=> { if (confirm('Clear local leaderboard?')){ localStorage.removeItem('leaderboard'); renderLeaderboard(); } });

/* ============================
   Main game loop
   ============================ */
function gameLoop(){
  if (!gameStarted || gamePaused){ rafId = null; return; }
  if (gameOver){ onGameOver(); rafId = null; return; }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#1e1e1e';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  drawPlayer();
  drawPowerupBars();

  drawObstacles();
  drawPowerups();

  movePlayer();
  updateObstacles();
  updatePowerups();
  updateTimers();
  checkCollisions();

  if (Math.random() < obstacleSpawnProb) generateObstacle();
  maybeSpawnPowerup();

  drawHUD();

  rafId = requestAnimationFrame(gameLoop);
}

/* move player helper */
function movePlayer(){
  player.x += player.dx;
  if (player.x < 0) player.x = 0;
  if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
}

/* restart */
function restartGame(){
  obstacles.length = 0;
  powerups.length = 0;
  score = 0;
  player.x = canvas.width / 2 - player.width / 2;
  player.dx = 0;
  invincible = slowed = speedBoosted = false;
  gameStarted = true;
  gamePaused = false;
  gameOver = false;
  coinCounterGame.style.display = 'block';
  if (!rafId) rafId = requestAnimationFrame(gameLoop);
}

/* init UI */
function initUI(){
  usernameScreen.classList.remove('hidden');
  titleScreen.classList.add('hidden');
  gameOverOverlay.classList.add('hidden');
  coinCounterGame.style.display = 'none';
  // load local values
  coins = parseInt(localStorage.getItem('coins') || '0', 10);
  unlockedColors = JSON.parse(localStorage.getItem('unlockedColors') || '["#00FF00"]');
  selectedColor = localStorage.getItem('selectedColor') || '#00FF00';
  selectedSkinLocal = localStorage.getItem('customSkinData') || null;
  highScore = parseInt(localStorage.getItem('highScore') || '0', 10);
  saveLocalState();
  renderColorGrid(colorGrid);
  renderSkins(skinsContainer);
  renderColorGrid(shopColorGrid);
  renderSkins(shopSkins);
}
initUI();

/* small helpers */
function saveLocalState(){ localStorage.setItem('coins', String(coins)); localStorage.setItem('unlockedColors', JSON.stringify(unlockedColors)); localStorage.setItem('selectedColor', selectedColor); if (selectedSkinLocal) localStorage.setItem('customSkinData', selectedSkinLocal); localStorage.setItem('highScore', String(highScore)); updateCoinDisplays(); }
function pushUI(){ saveLocalState(); updateCoinDisplays(); }

/* prevent accidental pointer behavior on overlays */
document.addEventListener('pointerdown', e => { const t = e.target; if (t === usernameInput || t === startUsernameBtn) e.preventDefault(); }, {passive:false});

/* Helper exposed for debugging if wanted */
window._gameState = () => ({ username, coins, unlockedColors, selectedColor, score, highScore });

</script>
</body>
</html>
